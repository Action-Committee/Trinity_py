name: Python CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/trinity_wallet_py/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Upgrade pip and install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install build

      - name: Install Python dependencies
        run: |
          if [ -f trinity_wallet_py/requirements.txt ]; then
            pip install -r trinity_wallet_py/requirements.txt
          fi

      - name: Build wheel (fail early if build issues)
        run: |
          python -m build -w --no-isolation

      - name: Install built wheel
        run: |
          ls -la dist || true
          if ls dist/*.whl 1> /dev/null 2>&1; then
            pip install dist/*.whl
          else
            echo "ERROR: No wheel file found in dist/"
            exit 1
          fi

      - name: Run tests
        run: |
          if [ -d tests ] || test -f pytest.ini || ls trinity_wallet_py/*.py >/dev/null 2>&1; then
            pip install pytest
            pytest -q
          else
            echo "No tests found"
          fi

      - name: "Optional: static analysis (uncomment if desired)"
        if: always()
        run: |
          echo "Static analysis step available; enable as needed."
